$(function() {
	$(".select .select_wrap").click(function() {
		if($(this).next().is(".option_wrap")){
			$(this).next().slideToggle(300);
			if($(this).next().css("display") == "block"){
				$(this).next().css("display", "flex");
			}
		}
	});

	var check_flag = [];
	$(".select_all").each(function(){
		check_flag[$(".select_all").index(this)] = false;
	});

	$(".select_all").on('click', function(e){
		e.stopPropagation();
		var sel_index = $(".select_all").index(this);
		if(!check_flag[sel_index]){
			$(this).parent().next().find("input[type=checkbox]").each(function(){
				$(this).prop('checked', true);
			});
			check_flag[sel_index] = true;
		}else{
			$(this).parent().next().find("input[type=checkbox]").each(function(){
				$(this).prop('checked', false);
			});
			check_flag[sel_index] = false;
		}
	});
});

function vgDelete(vg_delete) {
    $(vg_delete).on('click', function(e){
        if(!confirm('Подтвердить удаление')){
            return false;
        }else if($(this).is(".vg-dotted-square img.vg_delete") || $(this).is(".main_img > div > img.vg_delete")){
            e.stopPropagation();
			/*Удаление изображений галлереи*/
            delGalleryImg($(this));
			/*Удаление изображений галлереи*/
        }
    });
}

function delGalleryImg(img){
	/*Удаление изображений галлереи*/
    galImg = {};
    galImg.img_src = $(img).attr('src').substr($(img).attr('src').lastIndexOf("/") + 1);
    galImg.id = parseInt($(img).closest("form").children("input[type=hidden]:eq(0)").val());
    galImg.id_row = $(img).closest("form").children("input[type=hidden]:eq(0)").attr('name')
    galImg.table = $('input[name=table]').val();
    let file_name = $(img).closest(".gallery_container").find("input[type=file]").attr("name");
    if(file_name.lastIndexOf("[]") !== -1){
        galImg.row = file_name.substr(0, file_name.lastIndexOf("[]"));
    }else{
        galImg.row = file_name.substr(0);
    }
    if(typeof galImg.id == 'undefined' || isNaN(galImg.id)){
        galImg.id = false;
    }
    if(galImg.img_src && galImg.row){
        $.ajax({
            url: path,
            type: "POST",
            data:{
                ajax:'delete_gallery_img',
                data: JSON.stringify(galImg)
            },
            success: function(res){
                if(res){
                    $(img).parent().remove();
                }else{
                    alert('Ошибка удаления изображения');
                }
            }
        });
    }
	/*Удаление изображений галлереи*/
}

$(document).ready(function($){

	/*Поиск и меню*/
    $("#hideButton").click(function () {
        $(".vg-carcass").hasClass("vg-hide") ? $(".vg-carcass").removeClass("vg-hide") : $(".vg-carcass").addClass("vg-hide");
    })
    $("#searchButton").click(function () {
        $(".vg-search").addClass("vg-search-reverse");
        $(".vg-search").children("input").focus();
        $(".vg-search").focusout(function () {
            setTimeout(function(){
                $(".vg-search").removeClass("vg-search-reverse");
            },300);s
        });
    });
	/*Поиск и меню*/

	/*Показ блока с уведомлений*/
	if($("div").is(".error") || $("div").is(".success")){
		setTimeout(function(){
			$(".vg_modal").css('display', 'flex');
			$(".vg_modal").animate({opacity:1}, 500, function(){
				setTimeout(function(){
					$(".vg_modal").animate({opacity:0}, 500, function(){
						$(this).css('display', 'none');
					});
				}, 1500)
			});
		},300);
	}
	/*Показ блока с уведомлений*/

	/*УДАЛЕНИЕ ДАННЫХ*/
    vgDelete(".vg_delete");

	/*УДАЛЕНИЕ ДАННЫХ*/

	/*Показ загружаемых изображений*/

    $('.single_img, .gallery_img').on('change', function(){
        var container;
        var send_image = this;

        if($(this).is(".single_img")){
            container = $(this).closest(".img_container").find(".img_show");
        }else{
            container = $(this).closest(".gallery_container").find(".vg-dotted-square.empty_container");
            if(container.length < send_image.files.length){
                for (var i = 0; i < send_image.files.length - container.length; i++){
                    $(container).parent().append($(container[0]).clone());
                }
                container = $(this).closest(".gallery_container").find(".vg-dotted-square.empty_container");
            }
        }
        if (send_image && send_image.files[0]) {
            for(var i = 0; i < send_image.files.length; i++){
                $(container[i]).empty();
                readImage(send_image.files[i], i, container, function(e, item, index){
                    $(item).attr('src', e.target.result);
                });
            }
        }
    });

    function readImage(input, i, container, callback) {
        var reader = new FileReader();
        $(container[i]).append('<img class="img_item" src="">');
        var item = $(container[i]).children('img');
        reader.readAsDataURL(input);
        reader.onload = function (e) {
            callback(e, item, i);
        }
    }

	/*Показ загружаемых изображений*/

    /*Сортировка галлереи*/
    $('.gallery_container').sortable({
        cancel: ".empty_container, label",
        stop: function( event, ui ) {
            var img_items = $(this).children("div:not(.empty_container)").children("img");
            var img_src = {};
            for(var i = 0; i < img_items.length; i++){
                img_src[i] = img_items[i].currentSrc.substr(img_items[i].currentSrc.lastIndexOf("/") + 1);
            }

            if(img_src){
                img_src['id'] = $(this).closest("form").children("input[type=hidden]:eq(0)").val();
                img_src['id_row'] = $(this).closest("form").children("input[type=hidden]:eq(0)").attr('name');
                img_src['row'] = $(this).find("input[type=file]").attr("name").substr(0, $(this).find("input[type=file]").attr("name").lastIndexOf("[]"));
                img_src['table'] = $(this).closest("form").children("input[name=table]").val();
                $.ajax({
                    url: path,
                    type: "POST",
                    data:{
                        ajax:'sort_gallery_img',
                        data: JSON.stringify(img_src)
                    },
                    success: function(res){
                        if(res){
                            if(res != 'true'){
                                alert('Ошибка сортировки изображений');
                            }
                        }else{
                            alert('Ошибка сортировки изображений');
                        }
                    }
                });
            }
        }
    });
    /*Сортировка галлереи*/

	/*подсчет символов keywords и description*/
	var span_key;
	var span_desc;
	$("textarea[name=keywords], textarea[name=description]").on('focus input', function(){
		var count_chars = this.value.length;
		if($(this).is("textarea[name=keywords]")){
			if(!span_key){
				span_key = $(this).prev().text();
			}
            $(this).prev().text(span_key + ' ' + count_chars);
		}else{
            if(!span_desc){
                span_desc = $(this).prev().text();
            }
            $(this).prev().text(span_desc + ' ' + count_chars);
		}

	});
	/*подсчет символов keywords и description*/


	// close/show "add new user"

	$(".add_new_users a").on("click",function(e){
		e.preventDefault();
		$(".new_user_container").slideToggle();
		$(".new_user_container").css("display","flex");
	});

// close/show "add new user"


// close/show Events

	$(".add_new_group").on("click",function(){
		showModal();
	})

	$("#modal_users_ext").on("click",function(){
		closeModal();
	})

	$(".modal_overlay").on("click",function(){
		closeModal();
	});


// hide/show functions
	function closeModal(){
		$(".modal_users, .modal_overlay").fadeOut("slow");
	}
	function showModal () {
		$(".modal_users, .modal_overlay").fadeIn("slow");
		$(".modal_users").css("display","flex");
	}

// hide/show functions


	$(".add_new_client").on('click', function(e){
		e.preventDefault();
		$("form.new_client").slideToggle();
	});

    /*ajax поиск*/

    $('input[name=search]').on('input', function(e){
        e.preventDefault();
        if(this.value.length > 1){
            var str = this.value;
            $.ajax({
                url:path,
                type:"POST",
                data:{
                    ajax: 'search',
                    data: str
                },
                success: function(res){
                    if(res){
                        $(".search_res").empty().css('display', 'block');
                        res = JSON.parse(res);
                        for(var i = 0; i < res.length; i++){
                            $(".search_res").append('<a href="'+ res[i].link + '">'+ res[i].name +'</a>');
                        }
                        ajaxAdd();
                        $('html, body').on('click', function(){
                            if(!$(this).is(".search_res")){
                                $(".search_res").empty().css('display', 'none');
                                $('html, body').unbind('click');
                            }
                        });
                    }
                },
                error: function(){
                    alert('Ошибка выполнения запроса');
                }
            });
        }
    });

    //ajaxAdd();

    function ajaxAdd() {
        $("html").unbind('keydown');
        searchKeydown();

        $(".search_res a").on('mouseover', function(){
            $("html").unbind('keydown');
            $(".search_res a").removeAttr("class");
            $(this).addClass("search_act");
            $("input[name=search]").val($(this).text());
            searchKeydown();
        });
    }

    function searchKeydown(){
        $("html").on('keydown', function(e){
            if(e.keyCode == 40){
                e.preventDefault();
                if(!$(".search_res a").hasClass("search_act")){
                    $(".search_res a:first-child").addClass("search_act");
                    $("input[name=search]").val($(".search_res a:first-child").text());
                }else{
                    $(".search_res a").each(function(){
                        if($(this).hasClass("search_act")){
                            $(this).removeAttr("class");
                            if($(".search_res a").index(this) == $(".search_res a").length - 1){
                                $(".search_res a:first-child").addClass("search_act");
                                $("input[name=search]").val($(".search_res a:first-child").text());
                            }else{
                                $(this).next().addClass("search_act");
                                $("input[name=search]").val($(this).next().text());
                            }
                            return false;
                        }
                    });
                }
            }
            if(e.keyCode == 38){
                e.preventDefault();
                if(!$(".search_res a").hasClass("search_act")){
                    $(".search_res a:last-child").addClass("search_act");
                    $("input[name=search]").val($(".search_res a:last-child").text());
                }else{
                    $(".search_res a").each(function(){
                        if($(this).hasClass("search_act")){
                            $(this).removeAttr("class");
                            if($(".search_res a").index(this) == 0){
                                $(".search_res a:last-child").addClass("search_act");
                                $("input[name=search]").val($(".search_res a:last-child").text());
                            }else{
                                $(this).prev().addClass("search_act");
                                $("input[name=search]").val($(this).prev().text());
                            }
                            return false;
                        }
                    });
                }
            }
        });
    }

    /*ajax поиск*/

});
